{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.array.push.js\");\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n    return t;\n  };\n  return __assign.apply(this, arguments);\n};\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar d3Force = __importStar(require(\"d3-force\"));\nvar forceGrid_1 = __importDefault(require(\"./forceGrid\"));\nvar mysqlWorkbench_1 = __importDefault(require(\"./mysqlWorkbench\"));\nvar dagre_1 = require(\"../dagre\");\nfunction layout(data, options) {\n  var nodes = data.nodes,\n    edges = data.edges;\n  var width = options.width;\n  var height = options.height;\n  if (!(nodes === null || nodes === void 0 ? void 0 : nodes.length)) return Promise.resolve();\n  // 筛选非叶子节点，做Dagre布局\n  var noLeafNodes = [];\n  nodes.forEach(function (node) {\n    var relateEdges = edges.filter(function (edge) {\n      return edge.source === node.id || edge.target === node.id;\n    });\n    if (relateEdges.length > 1) {\n      var temp = __assign({}, node);\n      delete temp.size;\n      noLeafNodes.push(temp);\n    }\n  });\n  var noLeafEdge = [];\n  edges.forEach(function (edge) {\n    var sourceNode = noLeafNodes.find(function (node) {\n      return node.id === edge.source;\n    });\n    var targetNode = noLeafNodes.find(function (node) {\n      return node.id === edge.target;\n    });\n    if (sourceNode && targetNode) {\n      noLeafEdge.push(edge);\n    }\n  });\n  var graphLayout = new dagre_1.DagreLayout({\n    type: 'dagre',\n    ranksep: options.nodeMinGap,\n    nodesep: options.nodeMinGap\n  });\n  var nodesTmp = graphLayout.layout({\n    nodes: noLeafNodes,\n    edges: noLeafEdge\n  }).nodes;\n  // 布局后，坐标同步\n  nodes.forEach(function (n) {\n    var found = (nodesTmp || []).find(function (temp) {\n      return temp.id === n.id;\n    });\n    n.x = (found === null || found === void 0 ? void 0 : found.x) || width / 2;\n    n.y = (found === null || found === void 0 ? void 0 : found.y) || height / 2;\n  });\n  var copyNodes = JSON.parse(JSON.stringify(nodes));\n  var copyEdges = JSON.parse(JSON.stringify(edges));\n  var simulation = d3Force.forceSimulation().nodes(copyNodes).force(\"link\", d3Force.forceLink(copyEdges).id(function (d) {\n    return d.id;\n  }).distance(function (d) {\n    var edgeInfo = noLeafEdge.find(function (edge) {\n      return edge.source === d.source && edge.target === d.target;\n    });\n    if (edgeInfo) {\n      return 30;\n    }\n    return 20;\n  })).force(\"charge\", d3Force.forceManyBody()).force(\"center\", d3Force.forceCenter(width / 2, height / 2)).force(\"x\", d3Force.forceX(width / 2)).force(\"y\", d3Force.forceY(height / 2)).alpha(0.3).alphaDecay(0.08).alphaMin(0.001);\n  var layoutPromise = new Promise(function (resolve) {\n    simulation.on('end', function () {\n      // 坐标信息同步到nodes,edges中\n      nodes.forEach(function (node) {\n        var nodeInfo = copyNodes.find(function (item) {\n          return item.id === node.id;\n        });\n        if (nodeInfo) {\n          node.x = nodeInfo.x;\n          node.y = nodeInfo.y;\n        }\n      });\n      var minX = Math.min.apply(Math, nodes.map(function (node) {\n        return node.x;\n      }));\n      var maxX = Math.max.apply(Math, nodes.map(function (node) {\n        return node.x;\n      }));\n      var minY = Math.min.apply(Math, nodes.map(function (node) {\n        return node.y;\n      }));\n      var maxY = Math.max.apply(Math, nodes.map(function (node) {\n        return node.y;\n      }));\n      var scalex = width / (maxX - minX);\n      var scaley = height / (maxY - minY);\n      nodes.forEach(function (node) {\n        if (node.x !== undefined && scalex < 1) {\n          node.x = (node.x - minX) * scalex;\n        }\n        if (node.y !== undefined && scaley < 1) {\n          node.y = (node.y - minY) * scaley;\n        }\n      });\n      // 这一步就执行缩小空间。且不考虑节点size\n      nodes.forEach(function (node) {\n        node.sizeTemp = node.size;\n        node.size = [10, 10];\n      });\n      (0, mysqlWorkbench_1.default)(nodes, edges);\n      nodes.forEach(function (node) {\n        node.size = node.sizeTemp || [];\n        delete node.sizeTemp;\n      });\n      // 进行网格对齐+节点大小扩增\n      (0, forceGrid_1.default)({\n        nodes: nodes,\n        edges: edges\n      }, options);\n      resolve();\n    });\n  });\n  return layoutPromise;\n}\nexports.default = layout;","map":{"version":3,"mappings":"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","names":["layout","data","options","edges","width","height","nodes","length","Promise","resolve","noLeafNodes","forEach","node","relateEdges","filter","edge","source","id","target","temp","size","push","noLeafEdge","sourceNode","find","targetNode","graphLayout","dagre_1","type","ranksep","nodeMinGap","nodesep","nodesTmp","n","found","x","y","copyNodes","JSON","parse","stringify","copyEdges","simulation","d3Force","forceSimulation","force","forceLink","d","distance","edgeInfo","forceManyBody","forceCenter","forceX","forceY","alpha","alphaDecay","alphaMin","layoutPromise","on","nodeInfo","item","minX","Math","min","map","maxX","max","minY","maxY","scalex","scaley","undefined","sizeTemp","exports"],"sourceRoot":"","sources":["../../../src/layout/er/core.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script","externalDependencies":[]}
{"ast":null,"code":"import NProgress from 'nprogress';\nimport 'nprogress/nprogress.css';\nimport router from './router';\nimport { LOGIN_TOKEN } from '@/store/mutation-types';\nimport { useUserInfoStore, useMenuStore } from './store/index';\nimport { Message } from \"@arco-design/web-vue\";\nimport { getURLParams, goLogin } from '@/utils/getToken';\nimport { getTokenByCode } from \"@/api/login\";\nimport { addSSOEncrypt, getCookie, saveTokenCookie, clearCookie } from '@/utils/util.js';\nimport { LOGIN_PATH } from '@/store/mutation-types.js';\nimport { userInfo } from '@/api/login';\nlet isDev = !LOGIN_PATH.split('//')[1].startsWith('test');\nlet paramsCode = getURLParams().code;\nlet isInCodeFn = true;\n// 递归取出当前账号下所有菜单的url，路由跳转做校验，防止手动敲url跳转到没有权限的页面。\nlet menuListArr = new Set();\nmenuListArr.clear();\nrouter.options.routes[1].children.forEach(item => {\n  if (item.meta?.hidden) {\n    menuListArr.add(item.path);\n  }\n});\nfunction flatMenu(arr) {\n  Array.isArray(arr) && arr.forEach(item => {\n    menuListArr.add(item.url);\n    if (item.children && item.children.length) {\n      flatMenu(item.children);\n    }\n  });\n}\nmenuListArr.add('/');\nfunction logoutFn() {\n  const userStore = useUserInfoStore();\n  userStore.Logout().then(res => {\n    clearCookie(LOGIN_TOKEN);\n    setTimeout(() => {\n      goLogin();\n    }, 60);\n  }).catch(() => {\n    clearCookie(LOGIN_TOKEN);\n    setTimeout(() => {\n      goLogin();\n    }, 60);\n  });\n}\nlet result;\nasync function loginAfterData() {\n  const menuStore = useMenuStore();\n  try {\n    let resArr = await Promise.all([menuStore.menuSideBar()]);\n    console.log(resArr, 'resArr');\n    result = Promise.resolve(resArr);\n    flatMenu(resArr[0].data.menuList);\n  } catch (error) {\n    result = Promise.reject(error);\n  }\n  return result;\n}\nNProgress.configure({\n  showSpinner: false\n});\nconst loginRoutePath = '/login';\nconst defaultRoutePath = '/';\nrouter.beforeEach((to, from, next) => {\n  NProgress.start();\n  if (getCookie(LOGIN_TOKEN)) {\n    if (to.path == '/pageError') {\n      next();\n    } else if (to.path === loginRoutePath) {\n      next({\n        path: defaultRoutePath\n      });\n      NProgress.done();\n    } else {\n      const userStore = useUserInfoStore();\n      let Info = userStore.getUserInfo;\n      if (Info.roles === undefined) {\n        userInfo().then(res => {\n          if (res.code == \"000000000000\") {\n            userStore.info = res.data;\n            loginAfterData().then(() => {\n              next();\n              NProgress.done();\n            }).catch(() => {\n              Message.error('数据加载失败');\n            });\n          } else {\n            Message.error(res.message);\n            next({\n              path: '/pageError'\n            });\n          }\n        }).catch(err => {\n          Message.error(err);\n        });\n      } else {\n        if (menuListArr.has(to.path)) {\n          next();\n        } else {\n          next({\n            path: defaultRoutePath\n          });\n        }\n        NProgress.done();\n      }\n    }\n  } else if (paramsCode && isInCodeFn) {\n    let formData = new FormData();\n    formData.append(\"code\", paramsCode);\n    getTokenByCode(formData).then(res => {\n      if (res.code === \"000000000000\") {\n        let {\n          accessToken,\n          loginInfo\n        } = res.data;\n        saveTokenCookie(accessToken);\n        // loginInfo && addSSOEncrypt(isDev?'development':'test',loginInfo)\n        loginInfo && addSSOEncrypt(isDev ? 'development' : 'test', loginInfo);\n        isInCodeFn = false;\n        const userStore = useUserInfoStore();\n        let Info = userStore.getUserInfo;\n        if (Info.roles === undefined) {\n          userInfo().then(res => {\n            if (res.code == \"000000000000\") {\n              userStore.info = res.data;\n              loginAfterData().then(() => {\n                if (menuListArr.has(to.path)) {\n                  next();\n                } else {\n                  next({\n                    path: defaultRoutePath\n                  });\n                }\n                NProgress.done();\n              }).catch(() => {\n                Message.error('数据加载失败');\n              });\n            } else {\n              Message.error(res.message);\n              next({\n                path: '/pageError'\n              });\n            }\n          }).catch(err => {\n            Message.error(err);\n          });\n        } else {\n          if (menuListArr.has(to.path)) {\n            next();\n          } else {\n            next({\n              path: defaultRoutePath\n            });\n          }\n          NProgress.done();\n        }\n      } else {\n        Message.error(res.message);\n        console.log(111);\n        logoutFn();\n      }\n    });\n  } else {\n    console.log(222);\n    //没有token跳统一登录页\n    logoutFn();\n  }\n});\nrouter.afterEach(() => {\n  NProgress.done();\n});","map":{"version":3,"names":["NProgress","router","LOGIN_TOKEN","useUserInfoStore","useMenuStore","Message","getURLParams","goLogin","getTokenByCode","addSSOEncrypt","getCookie","saveTokenCookie","clearCookie","LOGIN_PATH","userInfo","isDev","split","startsWith","paramsCode","code","isInCodeFn","menuListArr","Set","clear","options","routes","children","forEach","item","meta","hidden","add","path","flatMenu","arr","Array","isArray","url","length","logoutFn","userStore","Logout","then","res","setTimeout","catch","result","loginAfterData","menuStore","resArr","Promise","all","menuSideBar","console","log","resolve","data","menuList","error","reject","configure","showSpinner","loginRoutePath","defaultRoutePath","beforeEach","to","from","next","start","done","Info","getUserInfo","roles","undefined","info","message","err","has","formData","FormData","append","accessToken","loginInfo","afterEach"],"sources":["/Users/lijiaxin/Documents/workspace/hydsoft-mgmt-frontend/src/permission.js"],"sourcesContent":["import NProgress from 'nprogress'\nimport 'nprogress/nprogress.css'\nimport router from './router'\nimport { LOGIN_TOKEN } from '@/store/mutation-types'\nimport { useUserInfoStore,useMenuStore } from './store/index'\nimport { Message } from \"@arco-design/web-vue\";\nimport { getURLParams, goLogin } from '@/utils/getToken'\nimport { getTokenByCode } from \"@/api/login\";\nimport { addSSOEncrypt,getCookie,saveTokenCookie,clearCookie } from '@/utils/util.js'\nimport { LOGIN_PATH } from '@/store/mutation-types.js'\nimport { userInfo} from '@/api/login'\nlet isDev = !LOGIN_PATH.split('//')[1].startsWith('test')\nlet paramsCode = getURLParams().code;\n\nlet isInCodeFn = true\n// 递归取出当前账号下所有菜单的url，路由跳转做校验，防止手动敲url跳转到没有权限的页面。\nlet menuListArr = new Set()\nmenuListArr.clear()\nrouter.options.routes[1].children.forEach(item => {\n  if (item.meta?.hidden) {\n    menuListArr.add(item.path)\n  }\n})\nfunction flatMenu(arr){\n    Array.isArray(arr) && arr.forEach(item=>{\n        menuListArr.add(item.url)\n        if(item.children && item.children.length){\n            flatMenu(item.children)\n        }\n    })\n}\nmenuListArr.add('/')\n\nfunction logoutFn(){\n    const userStore = useUserInfoStore()\n    userStore.Logout().then(res=>{\n        clearCookie(LOGIN_TOKEN)\n        setTimeout(() => {\n            goLogin();\n        }, 60);\n    }).catch(()=>{\n        clearCookie(LOGIN_TOKEN)\n        setTimeout(() => {\n            goLogin();\n        }, 60);\n    })\n}   \nlet result\nasync function loginAfterData(){\nconst menuStore = useMenuStore()\n    try {\n        let resArr =  await Promise.all([menuStore.menuSideBar()])\n        console.log(resArr,'resArr');\n        result = Promise.resolve(resArr)\n        flatMenu(resArr[0].data.menuList)\n    } catch (error) {\n        result = Promise.reject(error)\n    }\n    return result\n}\n\nNProgress.configure({ showSpinner: false })\nconst loginRoutePath = '/login'\nconst defaultRoutePath = '/'\nrouter.beforeEach((to,from,next)=>{\n    NProgress.start()\n    if(getCookie(LOGIN_TOKEN)){\n        if(to.path == '/pageError'){\n            next()\n        }else if (to.path === loginRoutePath) {\n            next({ path: defaultRoutePath })\n            NProgress.done()\n        }else {\n            const userStore = useUserInfoStore();\n            let Info = userStore.getUserInfo;\n            if (Info.roles === undefined) {\n                userInfo().then(res=>{\n                    if(res.code == \"000000000000\"){\n                        userStore.info = res.data;\n                        loginAfterData().then(()=>{\n                            next()\n                            NProgress.done();\n                        }).catch(()=>{\n                            Message.error('数据加载失败');\n                        })\n                    }else{\n                        Message.error(res.message);\n                        next({ path: '/pageError'});\n                    }\n                }).catch(err=>{\n                    Message.error(err)\n                })\n            }else {\n               if(menuListArr.has(to.path)){\n                    next()\n                }else {\n                    next({ path: defaultRoutePath})\n                }\n                NProgress.done()\n            }\n        }\n    }else if(paramsCode && isInCodeFn){\n        let formData = new FormData();\n        formData.append(\"code\", paramsCode);\n        getTokenByCode(formData).then(res => {\n            if (res.code === \"000000000000\") {\n                let { accessToken,loginInfo } = res.data;\n                saveTokenCookie(accessToken)\n                // loginInfo && addSSOEncrypt(isDev?'development':'test',loginInfo)\n                loginInfo && addSSOEncrypt(isDev?'development':'test',loginInfo)\n                isInCodeFn = false\n                const userStore = useUserInfoStore();\n                let Info = userStore.getUserInfo;\n                if (Info.roles === undefined) {\n                    userInfo().then(res=>{\n                        if(res.code == \"000000000000\"){\n                            userStore.info = res.data;\n                            loginAfterData().then(()=>{\n                                if(menuListArr.has(to.path)){\n                                    next()\n                                }else {\n                                    next({ path: defaultRoutePath})\n                                }\n                                NProgress.done();\n                            }).catch(()=>{\n                                Message.error('数据加载失败');\n                            })\n                        }else{\n                            Message.error(res.message);\n                            next({ path: '/pageError'});\n                        }\n                    }).catch(err=>{\n                        Message.error(err)\n                    })\n                }else {\n                    if(menuListArr.has(to.path)){\n                        next()\n                    }else {\n                        next({ path: defaultRoutePath})\n                    }\n                    NProgress.done()\n                }\n            }  else {\n                Message.error(res.message)\n                console.log(111);\n                logoutFn()\n            }\n        });\n    }else{\n        console.log(222);\n        //没有token跳统一登录页\n        logoutFn()\n    }\n})\n\nrouter.afterEach(() => {\n    NProgress.done()\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}
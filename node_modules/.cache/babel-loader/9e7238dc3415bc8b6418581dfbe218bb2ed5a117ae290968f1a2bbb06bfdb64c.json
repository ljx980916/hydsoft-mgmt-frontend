{"ast":null,"code":"\"use strict\";\n\n/**\n * @fileOverview MDS layout\n * @author shiwu.wyy@antfin.com\n */\nrequire(\"core-js/modules/es.error.cause.js\");\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.MDSLayout = void 0;\nvar ml_matrix_1 = require(\"ml-matrix\");\nvar util_1 = require(\"../util\");\nvar base_1 = require(\"./base\");\n/**\n * mds 布局\n */\nvar MDSLayout = /** @class */function (_super) {\n  __extends(MDSLayout, _super);\n  function MDSLayout(options) {\n    var _this = _super.call(this) || this;\n    /** 布局中心 */\n    _this.center = [0, 0];\n    /** 边长度 */\n    _this.linkDistance = 50;\n    _this.nodes = [];\n    _this.edges = [];\n    /** 迭代结束的回调函数 */\n    _this.onLayoutEnd = function () {};\n    _this.updateCfg(options);\n    return _this;\n  }\n  MDSLayout.prototype.getDefaultCfg = function () {\n    return {\n      center: [0, 0],\n      linkDistance: 50\n    };\n  };\n  /**\n   * 执行布局\n   */\n  MDSLayout.prototype.execute = function () {\n    var self = this;\n    var nodes = self.nodes,\n      _a = self.edges,\n      edges = _a === void 0 ? [] : _a;\n    var center = self.center;\n    if (!nodes || nodes.length === 0) {\n      if (self.onLayoutEnd) self.onLayoutEnd();\n      return;\n    }\n    if (nodes.length === 1) {\n      nodes[0].x = center[0];\n      nodes[0].y = center[1];\n      if (self.onLayoutEnd) self.onLayoutEnd();\n      return;\n    }\n    var linkDistance = self.linkDistance;\n    // the graph-theoretic distance (shortest path distance) matrix\n    var adjMatrix = (0, util_1.getAdjMatrix)({\n      nodes: nodes,\n      edges: edges\n    }, false);\n    var distances = (0, util_1.floydWarshall)(adjMatrix);\n    self.handleInfinity(distances);\n    // scale the ideal edge length acoording to linkDistance\n    var scaledD = (0, util_1.scaleMatrix)(distances, linkDistance);\n    self.scaledDistances = scaledD;\n    // get positions by MDS\n    var positions = self.runMDS();\n    self.positions = positions;\n    positions.forEach(function (p, i) {\n      nodes[i].x = p[0] + center[0];\n      nodes[i].y = p[1] + center[1];\n    });\n    if (self.onLayoutEnd) self.onLayoutEnd();\n    return {\n      nodes: nodes,\n      edges: edges\n    };\n  };\n  /**\n   * mds 算法\n   * @return {array} positions 计算后的节点位置数组\n   */\n  MDSLayout.prototype.runMDS = function () {\n    var self = this;\n    var dimension = 2;\n    var distances = self.scaledDistances;\n    // square distances\n    var M = ml_matrix_1.Matrix.mul(ml_matrix_1.Matrix.pow(distances, 2), -0.5);\n    // double centre the rows/columns\n    var rowMeans = M.mean(\"row\");\n    var colMeans = M.mean(\"column\");\n    var totalMean = M.mean();\n    M.add(totalMean).subRowVector(rowMeans).subColumnVector(colMeans);\n    // take the SVD of the double centred matrix, and return the\n    // points from it\n    var ret = new ml_matrix_1.SingularValueDecomposition(M);\n    var eigenValues = ml_matrix_1.Matrix.sqrt(ret.diagonalMatrix).diagonal();\n    return ret.leftSingularVectors.toJSON().map(function (row) {\n      return ml_matrix_1.Matrix.mul([row], [eigenValues]).toJSON()[0].splice(0, dimension);\n    });\n  };\n  MDSLayout.prototype.handleInfinity = function (distances) {\n    var maxDistance = -999999;\n    distances.forEach(function (row) {\n      row.forEach(function (value) {\n        if (value === Infinity) {\n          return;\n        }\n        if (maxDistance < value) {\n          maxDistance = value;\n        }\n      });\n    });\n    distances.forEach(function (row, i) {\n      row.forEach(function (value, j) {\n        if (value === Infinity) {\n          distances[i][j] = maxDistance;\n        }\n      });\n    });\n  };\n  MDSLayout.prototype.getType = function () {\n    return \"mds\";\n  };\n  return MDSLayout;\n}(base_1.Base);\nexports.MDSLayout = MDSLayout;","map":{"version":3,"mappings":"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","names":["__extends","options","_super","_this","updateCfg","MDSLayout","center","linkDistance","self","_a","edges","nodes","length","onLayoutEnd","x","y","adjMatrix","distances","handleInfinity","scaledD","scaledDistances","positions","runMDS","forEach","p","i","dimension","M","ml_matrix_1","mul","pow","rowMeans","mean","colMeans","totalMean","add","subRowVector","subColumnVector","ret","eigenValues","sqrt","diagonalMatrix","diagonal","leftSingularVectors","toJSON","map","row","splice","maxDistance","value","Infinity","j","base_1","exports"],"sourceRoot":"","sources":["../../src/layout/mds.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script","externalDependencies":[]}